<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
    xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
>
    <Product 
        Id="*" 
        Name="NITRINOnet Control Manager" 
        Language="1049" 
        Version="1.0.0" 
        Manufacturer="deymonster" 
        UpgradeCode="0547e595-c4be-4973-ab78-189148bc3900"
        Codepage="65001"
        >
        <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" />

        <MajorUpgrade 
            DowngradeErrorMessage="A newer version of [ProductName] is already installed."
           
             />
        <Media Id="1" Cabinet="product.cab" EmbedCab="yes" />

        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFilesFolder">
                <Directory Id="INSTALLFOLDER" Name="NITRINOnet Control Manager">
                    <Component Id="MainExecutable" Guid="c53a0add-887f-4983-a4c1-28acafa114a8">
                        <File Id="NITRINOnetControlManagerExe" Source="NITRINOnetControlManager.exe" KeyPath="yes" />
                        
                        <!-- Stop and remove the service if it's already present on installation -->
                        <ServiceControl Id="RemoveExistingService"
                            Name="NITRINOnetControlManager"
                            Stop="both"
                            Remove="install"
                            Wait="yes" />

                        <!-- Control service: Start on install, stop on uninstall -->
                        <ServiceControl Id="ControlService"
                            Name="NITRINOnetControlManager"
                            Start="install"
                            Stop="both"
                            Remove="uninstall"
                            Wait="yes" />

                       
                    </Component>

                    <!-- Add Firewall rule to allow port 9183 -->
                    <Component Id="FirewallRuleComponent" Guid="c7d4e154-292b-4a4e-a9b9-024b2f809839">
                        <util:FirewallException
                            Id="FirewallException9183"
                            Name="NITRINOnet Control Manager Port 9183"
                            Scope="any"
                            Port="9183"
                            Protocol="tcp"
                            Profile="any"
                            Program="[#NITRINOnetControlManagerExe]"
                            Description="Allow inbound access to NITRINOnet Control Manager on port 9183"/>
                    </Component>
                </Directory>
            </Directory>
        </Directory>

        <Feature Id="ProductFeature" Title="NITRINOnet Control Manager" Level="1">
            <ComponentRef Id="MainExecutable" />
            <ComponentRef Id="FirewallRuleComponent" />
        </Feature>
    </Product>
</Wix>