# Сборка Linux-агента Nitrino Net Control Manager

Этот документ описывает, как собрать бинарный файл сервиса для Linux из исходного кода репозитория.

## Предварительные требования

* Go версии 1.23 или новее (см. `go.mod`).
* Пакеты, необходимые для Linux-сборки, устанавливаются автоматически через `go mod tidy`.
* Для запуска тестов на Linux требуется доступ к утилитам `smartctl` и `nvme`, если вы собираетесь проверять диск health в рантайме.

## Структура исходного кода и build-теги

Код сервиса разделён по ОС с помощью build-тегов:

* `service/main_linux.go` соберётся только при `GOOS=linux` и запускает Linux-специфичную версию сервиса.
* `internal/collector/linux` содержит реализацию сборщика метрик для Linux.
* Общие компоненты (HTTP-сервер, загрузка конфигурации, менеджер секретов, логгер и сами объявления метрик) находятся в файлах без тегов и используются обеими платформами.

Благодаря этому при сборке Linux-варианта автоматически исключаются Windows-зависимости (`golang.org/x/sys/windows`, `github.com/StackExchange/wmi` и т.д.).

## Шаги сборки

1. Убедитесь, что зависимости актуальны:
   ```bash
   go mod tidy
   ```
2. Соберите бинарный файл сервиса, указав целевую ОС и архитектуру. Например, для `amd64`:
   ```bash
   GOOS=linux GOARCH=amd64 go build -o bin/nitrinonetcmanager ./service
   ```
   > ⚠️ **PowerShell:** переменные окружения задаются через `$env:`. Выполните
   >   ```powershell
   >   $env:GOOS = 'linux'
   >   $env:GOARCH = 'amd64'
   >   go build -o bin/nitrinonetcmanager ./service
   >   ```
   >   В классическом `cmd.exe` используйте `set GOOS=linux` и `set GOARCH=amd64` перед запуском `go build`.

   При выполнении команды компилятор выберет `service/main_linux.go` и Linux-реализацию сборщика.
3. (Опционально) Запустите модульные тесты под Linux:
   ```bash
   GOOS=linux GOARCH=amd64 go test ./...
   ```

Полученный бинарный файл `bin/nitrinonetcmanager` запускает HTTP API и экспортёр метрик, полностью аналогичные Windows-версии.

## Установка в системе

* Разместите бинарный файл и каталог конфигурации (по умолчанию `/etc/nitrinonetcmanager`) на целевой машине.
* Настройте логирование: по умолчанию файлы пишутся в `/var/log/nitrinonetcmanager/service.log`, путь можно переопределить переменной `NCM_LOG_FILE`.
* Создайте unit-файл systemd или другой механизм автозапуска, прописав нужные переменные окружения (`NCM_CONFIG_PATH`, `NCM_CERT_DIR`, `NCM_HANDSHAKE_KEY`, `NCM_API_PASSWORD` и т.д.).

## Кросс-компиляция

Go позволяет собирать Linux-бинарь и на других платформах. Достаточно задать переменные окружения `GOOS` и `GOARCH`, как показано выше. Внешние заголовки и компиляторы не требуются, так как проект состоит из чистого Go-кода.

