# План рефакторинга подсистемы сборщиков

Этот документ описывает, какие изменения предлагается внести в проект, чтобы реализовать требования к новой абстракции `collector.Interface` и обеспечить разделение платформенно-зависимого кода.

## 1. Введение общей абстракции `collector.Interface`

* Создать пакет `internal/collector`, в котором будет находиться интерфейс `Interface` с двумя методами:
  * `RegisterMetrics(prometheus.Registerer) error` — отвечает за регистрацию всех метрик, необходимых конкретной реализации сборщика.
  * `Start(context.Context) error` — запускает фоновые задачи, которые обновляют метрики (чтение конфигов, таймеры, наблюдение за устройствами и т.д.).
* Интерфейс будет использоваться сервисом, чтобы абстрагироваться от конкретных реализаций для разных ОС.

## 2. Реализация фабрики с выбором по ОС

* В пакет `internal/collector` добавить фабричную функцию `New(os string) (collector.Interface, error)`, которая внутри делегирует на скрытую функцию `newForOS`.
* Для Windows создать файл `internal/collector/factory_windows.go` с build-тегом `//go:build windows`, который возвращает реальную реализацию.
* Для остальных систем добавить файл `internal/collector/factory_default.go` с build-тегом `//go:build !windows`, возвращающий заглушку и ошибку «не реализовано» — чтобы не ломать сборку на несуппортируемых платформах, но явно сигнализировать о нехватке реализации.

## 3. Перемещение Windows-специфичного кода

* Текущий код, который занимается регистрацией метрик и запуском сборщиков на Windows, перенести в новый пакет `internal/collector/windows`.
* Внутри пакета определить тип `Collector`, реализующий интерфейс `collector.Interface`.
* В методе `RegisterMetrics` оставить всю логику регистрации метрик, включая ветвление для mock-режима.
* В методе `Start` инкапсулировать вызовы `metrics.Record...`, запуск вотчеров конфигов и фонового обновления mock-метрик.
* Файл должен собираться только на Windows, поэтому в нём также используется build-тег `//go:build windows`.

## 4. Обновление сервиса

* В `service/main.go` добавить вызов `collector.New(runtime.GOOS)` сразу после настройки логирования.
* В зависимости от результата фабрики:
  * На Windows — получить конкретную реализацию, зарегистрировать метрики, запустить `Start` и продолжить существующий HTTP-сервер.
  * На других ОС — выводить информативное сообщение о том, что сборщик не реализован, и завершать работу с ошибкой.
* Таким образом, логика запуска сервиса остаётся прежней для Windows, но код теперь готов к будущим расширениям.

## 5. Выделение общих вспомогательных модулей

* Переместить логику работы с конфигом устройств из `watcher/watcher.go` в новый пакет `internal/deviceconfig`:
  * Функции чтения, валидации и слежения за изменениями файла конфигурации.
  * Экспортировать типы данных (например, структуру конфигурации), которые используются в `metrics`.
* Аналогично, вынести работу с mock-конфигом в пакет `internal/mockconfig`:
  * Функции загрузки YAML, проверки, применения конфигурации.
  * Вотчер файла mock-конфига и публичный метод `Snapshot`, который возвращает готовую структуру для применения.
* Оба пакета должны быть платформенно нейтральными, чтобы впоследствии их можно было использовать в других реализациях коллектора (например, для Linux).

## 6. План миграции

1. Создать интерфейс и фабрику (п.1–2).
2. Перенести Windows-реализацию в `internal/collector/windows` (п.3).
3. Обновить сервис, используя новую фабрику (п.4).
4. Переименовать и переместить общие хелперы (п.5).
5. Убедиться, что сборка и запуск на Windows не изменились, а тесты и линтеры продолжают работать.

## 7. Ожидаемые выгоды

* Чёткое разделение платформенно-зависимого кода облегчает поддержку и развитие проекта.
* Добавление поддержки других ОС сводится к реализации нового пакета `internal/collector/<os>`.
* Общий код (watchers, mock-конфиг) становится переиспользуемым и тестируемым независимо от платформы.
* Сервис `main.go` становится проще и чище, так как не содержит большого количества условных секций под Windows.

## 8. Сборка после рефакторинга

* **Windows (`GOOS=windows`)** — во время `go build`/`go test` будут выбраны файлы `internal/collector/factory_windows.go` и `internal/collector/windows/collector.go`, так как они помечены тегом `//go:build windows`. Фабрика вернёт реальную реализацию, и сборка пройдёт без изменений по сравнению с текущим состоянием проекта.
* **Другие ОС (`GOOS!=windows`)** — компилятор задействует `internal/collector/factory_default.go` с тегом `//go:build !windows`, который возвращает заглушку и ошибку «не реализовано». Таким образом, бинарь соберётся, но при запуске сервис завершится, явно сообщив, что нужная реализация отсутствует.
* **Перенесённые общие пакеты** — код из `internal/deviceconfig` и `internal/mockconfig` не содержит платформенных ограничений, поэтому собирается на любой системе и может использоваться будущими реализациями коллекторов.

